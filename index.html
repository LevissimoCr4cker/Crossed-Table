<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Find the School that Matches Your Interests</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>Find the School that Matches Your Interests</header>
  <div class="container" id="criteria-container"></div>
  <button id="findBtn" class="btn">Find Top Matches</button>
  <div class="results" id="results"></div>

  <script>
    // Criteria
    const criteria = [
      "Scholarship Accessibility",
      "Academic Quality",
      "Employment Opportunities",
      "Innovation & Modern Programs",
      "International Environment",
      "Research Activity",
      "Infrastructure & IT Support",
      "Sports & Campus Life",
      "Food & Dining Facilities",
      "Campus Environment"
    ];

    // Fetch university data
    let universities = [];
    fetch('data/schools.json')
      .then(response => response.json())
      .then(data => {
        universities = data;
        initializeCriteria();
      })
      .catch(error => {
        console.error('Error fetching university data:', error);
        document.getElementById('results').innerHTML = "<p>Error loading university data. Please try again later.</p>";
      });

    // Generate star inputs
    function initializeCriteria() {
      const container = document.getElementById('criteria-container');
      criteria.forEach(c => {
        const div = document.createElement('div');
        div.className = 'criterion';
        div.innerHTML = `<label for="${c.replace(/\s+/g, '-')}-stars">${c}:</label><div class="stars" data-criterion="${c}" id="${c.replace(/\s+/g, '-')}-stars">
          <span class="star" data-value="1" role="button" aria-label="1 star for ${c}">&#9733;</span>
          <span class="star" data-value="2" role="button" aria-label="2 stars for ${c}">&#9733;</span>
          <span class="star" data-value="3" role="button" aria-label="3 stars for ${c}">&#9733;</span>
          <span class="star" data-value="4" role="button" aria-label="4 stars for ${c}">&#9733;</span>
          <span class="star" data-value="5" role="button" aria-label="5 stars for ${c}">&#9733;</span>
        </div>`;
        container.appendChild(div);
      });

      // Star click
      document.querySelectorAll('.stars').forEach(starContainer => {
        starContainer.addEventListener('click', e => {
          if (!e.target.classList.contains('star')) return;
          const val = parseInt(e.target.dataset.value);
          [...starContainer.children].forEach(star => {
            star.classList.toggle('filled', parseInt(star.dataset.value) <= val);
          });
        });
      });
    }

    // Find matches
    document.getElementById('findBtn').addEventListener('click', () => {
      const userPrefs = {};
      document.querySelectorAll('.stars').forEach(container => {
        const crit = container.dataset.criterion;
        const filledStars = container.querySelectorAll('.star.filled').length;
        userPrefs[crit] = filledStars;
      });

      const mandatoryCriteria = criteria.filter(c => userPrefs[c] === 5);

      const filtered = universities
        .filter(u => {
          if (mandatoryCriteria.length === 0) return true;
          return mandatoryCriteria.every(c => u[c] === 5);
        })
        .map(u => {
          let score = 0;
          criteria.forEach(c => {
            if (userPrefs[c] !== 5) {
              score += 5 - Math.abs(u[c] - userPrefs[c]);
            }
          });
          return { ...u, score };
        })
        .sort((a, b) => b.score - a.score);

      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = "";

      if (filtered.length === 0) {
        resultsDiv.innerHTML = "<p>No match found based on your 5-star preferences.</p>";
      } else {
        filtered.forEach(u => {
          const card = document.createElement('div');
          card.className = "card";
          let criteriaHTML = '<ul>';
          criteria.forEach(c => {
            const stars = '★'.repeat(u[c]) + '☆'.repeat(5 - u[c]);
            criteriaHTML += `<li>${c}: <span class="result-stars">${stars}</span></li>`;
          });
          criteriaHTML += '</ul>';
          card.innerHTML = `<h3>${u.School}</h3>${criteriaHTML}<p>Match Score: ${u.score}</p>`;
          resultsDiv.appendChild(card);
        });
      }

      // Retry button
      const retryBtn = document.createElement('button');
      retryBtn.textContent = "Retry";
      retryBtn.className = "btn retry-btn";
      retryBtn.setAttribute('aria-label', 'Retry selection');
      retryBtn.setAttribute('role', 'button');
      retryBtn.onclick = () => {
        document.querySelectorAll('.star').forEach(s => s.classList.remove('filled'));
        resultsDiv.innerHTML = "";
      };
      resultsDiv.appendChild(retryBtn);
    });
  </script>
</body>
</html>
